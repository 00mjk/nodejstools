<ui:DialogWindowVersioningWorkaround
    x:Class="Microsoft.NodejsTools.NpmUI.NpmPackageInstallWindow"
    x:ClassModifier="internal"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:npmUi="clr-namespace:Microsoft.NodejsTools.NpmUI"
    xmlns:ui="clr-namespace:Microsoft.VisualStudioTools"
    xmlns:wpf="clr-namespace:Microsoft.VisualStudioTools.Wpf"
    Title="npm Package Manager"
    Height="500"
    MinHeight="500"
    Width="600"
    MinWidth="600"
    WindowStartupLocation="CenterOwner"
    Background="{DynamicResource {x:Static wpf:Controls.BackgroundKey}}"
    ResizeMode="CanResizeWithGrip">
    <!-- Theming -->
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Microsoft.NodejsTools;component/SharedProject/Wpf/Controls.xaml" />
                
                <ResourceDictionary>
                    <Style TargetType="{x:Type ListViewItem}" BasedOn="{StaticResource {x:Type ListViewItem}}">
                        <Setter Property="HorizontalAlignment" Value="Stretch" />
                    </Style>
                    
                    <DataTemplate DataType="{x:Type npmUi:InstallCommandPackageCatalogEntryViewModel}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <!-- Command -->
                                <RowDefinition Height="auto" />
                                <!-- Separator -->
                                <RowDefinition Height="auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" TextWrapping="Wrap" Margin="3 6">
                                <Run>Execute</Run>
                                <Run FontWeight="Bold">npm install</Run>
                                <Run FontWeight="Bold" Text="{Binding Name,Mode=OneWay}" />
                            </TextBlock>
                            
                            <Separator Grid.Row="1" Margin="0 4 0 2" />

                            <Grid.InputBindings>
                                <MouseBinding Gesture="LeftDoubleClick"
                                              Command="{x:Static npmUi:NpmPackageInstallViewModel.InstallCommand}"
                                              CommandParameter="{Binding}" />
                            </Grid.InputBindings>
                        </Grid>
                    </DataTemplate>
                    
                    <DataTemplate DataType="{x:Type npmUi:ReadOnlyPackageCatalogEntryViewModel}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <!-- Name/Version/Author -->
                                <RowDefinition Height="auto" />
                                <!-- Description -->
                                <RowDefinition Height="auto" />
                                <!-- Keywords/Install -->
                                <RowDefinition Height="auto" />
                                <!-- Separator -->
                                <RowDefinition Height="auto" />
                            </Grid.RowDefinitions>

                            <Grid Grid.Row="0" Margin="3">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="auto" />
                                    <ColumnDefinition Width="auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="auto" />
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0"
                                           Text="{Binding Name,Mode=OneWay}"
                                           TextTrimming="CharacterEllipsis"
                                           ToolTip="{Binding Name,Mode=OneWay}"
                                           FontWeight="Bold" />

                                <TextBlock Grid.Column="1"
                                           Margin="3 0 0 0"
                                           Text="{Binding Version,Mode=OneWay}" />

                                <TextBlock Grid.Column="3"
                                           Text="{Binding Author,Mode=OneWay}"
                                           TextTrimming="CharacterEllipsis"
                                           ToolTip="{Binding Author,Mode=OneWay}"
                                           Opacity="0.6" />
                            </Grid>

                            <TextBlock Grid.Row="1"
                                       Margin="3"
                                       Text="{Binding Description,Mode=OneWay}"
                                       TextWrapping="Wrap" />

                            <Grid Grid.Row="2" Margin="3 6 3 3">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="auto" />
                                    <ColumnDefinition Width="auto" />
                                    <ColumnDefinition Width="auto" />
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0"
                                           Text="{Binding Keywords,Mode=OneWay}"
                                           TextWrapping="Wrap"
                                           Opacity="0.5" />

                                <TextBlock Grid.Column="1"
                                           x:Name="LocalInstallMessage"
                                           Visibility="Collapsed"
                                           FontWeight="Bold">
                                    Installed locally
                                </TextBlock>
                                <TextBlock Grid.Column="1"
                                           x:Name="LocalInstallOutOfDateMessage"
                                           Visibility="Collapsed"
                                           FontWeight="Bold"
                                           Foreground="Red">
                                    <Run>Old version</Run>
                                    <Run Text="{Binding LocalVersion,Mode=OneWay}" />
                                    <Run>installed locally</Run>
                                </TextBlock>
                                <TextBlock Grid.Column="2"
                                           x:Name="InstallMessageSeparator"
                                           Visibility="Collapsed">
                                    <Run xml:space="preserve">; </Run>
                                </TextBlock>
                                
                                <TextBlock Grid.Column="3"
                                           x:Name="GlobalInstallMessage"
                                           Visibility="Collapsed"
                                           FontWeight="Bold">
                                    Installed globally
                                </TextBlock>
                                <TextBlock Grid.Column="3"
                                           x:Name="GlobalInstallOutOfDateMessage"
                                           Visibility="Collapsed"
                                           FontWeight="Bold"
                                           Foreground="Red">
                                    <Run>Old version</Run>
                                    <Run Text="{Binding GlobalVersion,Mode=OneWay}" />
                                    <Run>installed globally</Run>
                                </TextBlock>
                            </Grid>

                            <Separator Grid.Row="3" Margin="0 4 0 2" />
                            
                            <Grid.InputBindings>
                                <MouseBinding Gesture="LeftDoubleClick"
                                              Command="{x:Static npmUi:NpmPackageInstallViewModel.InstallCommand}"
                                              CommandParameter="{Binding}" />
                            </Grid.InputBindings>
                        </Grid>
                        
                        <DataTemplate.Triggers>
                            <DataTrigger Binding="{Binding IsInstalledLocally}" Value="true">
                                <Setter TargetName="LocalInstallMessage" Property="Visibility" Value="Visible" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsLocalInstallOutOfDate}" Value="true">
                                <Setter TargetName="LocalInstallMessage" Property="Visibility" Value="Collapsed" />
                                <Setter TargetName="LocalInstallOutOfDateMessage" Property="Visibility" Value="Visible" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsInstalledGlobally}" Value="true">
                                <Setter TargetName="GlobalInstallMessage" Property="Visibility" Value="Visible" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsGlobalInstallOutOfDate}" Value="true">
                                <Setter TargetName="GlobalInstallMessage" Property="Visibility" Value="Collapsed" />
                                <Setter TargetName="GlobalInstallOutOfDateMessage" Property="Visibility" Value="Visible" />
                            </DataTrigger>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding IsInstalledLocally}" Value="true" />
                                    <Condition Binding="{Binding IsInstalledGlobally}" Value="true" />
                                </MultiDataTrigger.Conditions>
                                <Setter TargetName="InstallMessageSeparator" Property="Visibility" Value="Visible" />
                            </MultiDataTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                    
                    <DataTemplate DataType="{x:Type npmUi:LastRefreshedMessageProvider}">
                        <Grid HorizontalAlignment="Stretch">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0"
                                       Margin="0 0 3 0"
                                       VerticalAlignment="Center">
                                Catalog last updated: 
                            </TextBlock>
                            <TextBlock Grid.Column="1"
                                       x:Name="Message"
                                       Text="{Binding Description}"
                                       VerticalAlignment="Center" />
                        </Grid>
                        <DataTemplate.Triggers>
                            <DataTrigger Binding="{Binding IsAncient}" Value="True">
                                <Setter TargetName="Message" Property="Foreground" Value="Red" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsOld}" Value="True">
                                <Setter TargetName="Message" Property="FontWeight" Value="Bold" />
                            </DataTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                </ResourceDictionary>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>
    
    <Window.CommandBindings>
        <CommandBinding Command="ApplicationCommands.Close"
                        Executed="Close_Executed"
                        CanExecute="Close_CanExecute" />
        <CommandBinding Command="{x:Static npmUi:NpmPackageInstallViewModel.InstallCommand}"
                        Executed="InstallCommand_Executed"
                        CanExecute="InstallCommand_CanExecute" />
        <CommandBinding Command="{x:Static npmUi:NpmPackageInstallViewModel.RefreshCatalogCommand}"
                        Executed="RefreshCatalogCommand_Executed"
                        CanExecute="RefreshCatalogCommand_CanExecute" />
    </Window.CommandBindings>

    <Window.InputBindings>
        <KeyBinding Command="{x:Static npmUi:NpmPackageInstallViewModel.InstallCommand}" Gesture="ENTER" />
    </Window.InputBindings>

    <Grid>
        <DockPanel VerticalAlignment="Stretch"
                   Height="Auto"
                   HorizontalAlignment="Stretch"
                   Width="Auto"
                   Margin="4 4 4 4">

            <!-- These labels should be Hidden but not Collapsed, to ensure
                 the spacing is correct. -->
            <wpf:LabelledControl Title="Enter a search term or arguments for npm install:"
                                 DockPanel.Dock="Top"
                                 HorizontalAlignment="Stretch"
                                 VerticalAlignment="Center"
                                 Visibility="{Binding FilterControlsVisibility}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <!-- Text field -->
                        <ColumnDefinition Width="*" />
                        <!-- Dependency type: standard, dev, optional, global -->
                        <ColumnDefinition Width="Auto" />
                        <!-- Install button -->
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <TextBox Grid.Column="0" Grid.Row="0"
                             x:Name="FilterTextBox"
                             IsVisibleChanged="FilterTextBox_IsVisibleChanged"
                             Height="24"
                             Text="{Binding FilterText,UpdateSourceTrigger=PropertyChanged}"
                             PreviewKeyDown="FilterTextBox_PreviewKeyDown"
                             KeyboardNavigation.TabIndex="0" />

                    <ComboBox x:Name="DependencyComboBox"
                              Grid.Column="1"
                              Width="100"
                              MaxHeight="24"
                              Padding="3"
                              Margin="4 0 0 0"
                              SelectedIndex="{Binding SelectedDependencyTypeIndex}"
                              KeyboardNavigation.TabIndex="2">
                        <ComboBoxItem Tag="St" IsSelected="True">Standard</ComboBoxItem>
                        <ComboBoxItem Tag="Dev">Development</ComboBoxItem>
                        <ComboBoxItem Tag="Opt">Optional</ComboBoxItem>
                        <ComboBoxItem Tag="Global">Global</ComboBoxItem>
                    </ComboBox>
                    <Button x:Name="InstallButton"
                            Grid.Column="2"
                            Grid.Row="0"
                            Content="Install"
                            Command="{x:Static npmUi:NpmPackageInstallViewModel.InstallCommand}"
                            CommandParameter="{Binding SelectedPackage}"
                            KeyboardNavigation.TabIndex="3" />
                </Grid>
            </wpf:LabelledControl>

            <!-- Dialog control -->
            
            <Grid DockPanel.Dock="Bottom">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="auto" />
                </Grid.ColumnDefinitions>

                <Border Style="{StaticResource TooltipBorder}"
                        Visibility="{Binding GlobalWarningVisibility}">
                    <TextBlock VerticalAlignment="Center"
                               Foreground="{DynamicResource {x:Static wpf:Controls.TooltipTextKey}}">
                        <Run FontWeight="Bold">Warning:</Run> Global installs
                        will affect other apps that use packages via 'npm link'.
                    </TextBlock>
                </Border>
                
                <Button x:Name="CloseButton"
                        Grid.Column="1"
                        Command="ApplicationCommands.Close"
                        IsCancel="True"
                        KeyboardNavigation.TabIndex="5">
                    _Close
                </Button>
            </Grid>
            
            
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="3*" MinHeight="30" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                
                <!-- Package List -->
                
                <ListView x:Name="_packageList"
                          Grid.Row="0"
                          ItemsSource="{Binding FilteredPackages}"
                          SelectedItem="{Binding SelectedPackage}"
                          SelectionChanged="_packageList_SelectionChanged"
                          Visibility="{Binding FilteredCatalogListVisibility}"
                          PreviewKeyDown="_packageList_PreviewKeyDown"
                          HorizontalContentAlignment="Stretch"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                          MinHeight="0"
                          KeyboardNavigation.TabIndex="1" />


                <StackPanel Grid.Row="0"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Center"
                            Visibility="{Binding LoadingCatalogControlVisibility}">
                    <Label Content="{Binding LoadingCatalogMessage}"
                           HorizontalAlignment="Center"
                           HorizontalContentAlignment="Center"></Label>
                    <ProgressBar Height="16"
                                 Margin="50, 4, 50, 4"
                                 IsIndeterminate="True"
                                 IsEnabled="{Binding IsLoadingCatalog}" />
                </StackPanel>

                <!-- Splitter -->

                <Separator Grid.Row="1"
                           Margin="0 3 0 5"
                           Height="2"
                           IsHitTestVisible="False"/>
                <Separator Grid.Row="1"
                           Margin="0 5 0 3"
                           Height="2"
                           IsHitTestVisible="False"/>
                <GridSplitter Grid.Row="1"
                              ResizeBehavior="PreviousAndNext"
                              ResizeDirection="Rows"
                              Background="Transparent"
                              HorizontalAlignment="Stretch"
                              VerticalAlignment="Stretch"
                              KeyboardNavigation.IsTabStop="False" />

                <!-- Cache control and output -->
                <!-- (Together in the same grid so the splitter works) -->
                
                <Grid Grid.Row="2">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    
                    <!-- Package cache control -->

                    <Grid Grid.Row="0"
                          HorizontalAlignment="Stretch"
                          Visibility="{Binding CatalogControlVisibility}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="auto" />
                        </Grid.ColumnDefinitions>

                        <ContentControl Grid.Column="0"
                                        Content="{Binding LastRefreshedMessage}"
                                        Foreground="{DynamicResource {x:Static wpf:Controls.ForegroundKey}}"
                                        VerticalAlignment="Center"
                                        HorizontalAlignment="Stretch"
                                        Focusable="False"
                                        IsTabStop="False" />
                        
                        <Button Grid.Column="1"
                                Name="RefreshButton"
                                Command="{x:Static npmUi:NpmPackageInstallViewModel.RefreshCatalogCommand}"
                                KeyboardNavigation.TabIndex="4">
                            _Refresh Catalog
                        </Button>
                    </Grid>

                    <!-- Npm Output -->

                    <npmUi:NpmOutputControl Grid.Row="1"
                                            x:Name="ExecuteControl"
                                            DataContext="{Binding Path=ExecuteViewModel}"
                                            IsTabStop="False" />
                </Grid>
            </Grid>

            
        </DockPanel>
        
    </Grid>
</ui:DialogWindowVersioningWorkaround>
